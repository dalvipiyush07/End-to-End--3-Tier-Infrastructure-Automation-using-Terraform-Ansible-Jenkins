pipeline {
    agent any

    stages {
        stage('Run Ansible via Ansible Server') {
            steps {
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'ansible-key',
                        keyFileVariable: 'SSH_KEY'
                    )
                ]) {
                    sh '''
set -e

ssh -o StrictHostKeyChecking=no -i $SSH_KEY ec2-user@3.111.52.174 <<EOF
echo "=== Connected to Ansible Server ==="

# Go to repo directory
cd /home/ec2-user

# Clone or update repo
if [ ! -d 3-tier ]; then
    git clone https://github.com/dalvipiyush07/3-tier.git
else
    cd 3-tier && git pull && cd ..
fi

cd /home/ec2-user/3-tier

# Prepare Ansible playbook directory
sudo mkdir -p /etc/ansible/playbook
sudo chown ec2-user:ec2-user /etc/ansible/playbook

# Copy inventory, playbooks and website
cp ansible/inventory.ini /etc/ansible/playbook/
cp ansible/web.yml /etc/ansible/playbook/
cp ansible/app.yml /etc/ansible/playbook/
cp -r website /etc/ansible/playbook/

cd /etc/ansible/playbook

# Syntax check
ansible-playbook --syntax-check -i inventory.ini web.yml
ansible-playbook --syntax-check -i inventory.ini app.yml

# Run playbooks
ansible-playbook -i inventory.ini web.yml
ansible-playbook -i inventory.ini app.yml

echo "=== Ansible Execution Completed ==="
EOF
'''
                }
            }
        }
    }
}
