pipeline {
    agent any

    environment {
        ANSIBLE_USER = "ec2-user"
        ANSIBLE_HOST = "3.111.52.174"
    }

    stages {
        stage('Run Ansible from Remote Server') {
            steps {
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'ansible-key',
                        keyFileVariable: 'SSH_KEY'
                    )
                ]) {
                    sh '''
                        chmod 600 $SSH_KEY

                        ssh -o StrictHostKeyChecking=no \
                            -i $SSH_KEY \
                            ${ANSIBLE_USER}@${ANSIBLE_HOST} << 'EOF'

                        cd /home/ec2-user/ansible
                        ansible-playbook -i inventory.ini web.yml
                        ansible-playbook -i inventory.ini app.yml

                        EOF
                    '''
                }
            }
        }
    }
}
